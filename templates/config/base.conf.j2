{%- import '_macros.j2' as macros with context -%}

{% set config = manala_telegraf_config -%}

{% set config_tags = [] -%}
{% set config_agent = [] -%}

{%- for configs in config -%}
    {%- for config_name, config_parameters in configs.iteritems() -%}
        {%- if config_name == 'tags' -%}
            {%- if config_tags.extend(config_parameters) -%}{%- endif -%}
        {%- elif config_name == 'agent' -%}
            {%- if config_agent.extend(config_parameters) -%}{%- endif -%}
        {%- endif -%}
    {%- endfor -%}
{%- endfor -%}

# Telegraf configuration

# Telegraf is entirely plugin driven. All metrics are gathered from the
# declared inputs, and sent to the declared outputs.

# Plugins must be declared in here to be active.
# To deactivate a plugin, comment out the name and any variables.

# Use 'telegraf -config telegraf.conf -test' to see what metrics a config
# file would generate.

# Global tags can be specified here in key="value" format.
[tags]
  # dc = "us-east-1" # will tag all metrics with dc=us-east-1
  # rack = "1a"
{{ macros.config(config_tags, [], 2) -}}

# Configuration for telegraf agent
[agent]
  # Default data collection interval for all plugins
  {{ macros.config_row(config_agent, 'interval', 'interval = "10s"', 0, true) }}
  # Rounds collection interval to 'interval'
  # ie, if interval="10s" then always collect on :00, :10, :20, etc.
  {{ macros.config_row(config_agent, 'round_interval', 'round_interval = true', 0, true) }}

  # Default data flushing interval for all outputs. You should not set this below
  # interval. Maximum flush_interval will be flush_interval + flush_jitter
  {{ macros.config_row(config_agent, 'flush_interval', 'flush_interval = "10s"', 0, true) }}
  # Jitter the flush interval by a random amount. This is primarily to avoid
  # large write spikes for users running a large number of telegraf instances.
  # ie, a jitter of 5s and interval 10s means flushes will happen every 10-15s
  {{ macros.config_row(config_agent, 'flush_jitter', 'flush_jitter = "0s"', 0, true) }}

  # Run telegraf in debug mode
  {{ macros.config_row(config_agent, 'debug', 'debug = false', 0, true) }}
  # Run telegraf in quiet mode
  {{ macros.config_row(config_agent, 'quiet', 'quiet = false', 0, true) }}
  # Override default hostname, if empty use os.Hostname()
  {{ macros.config_row(config_agent, 'hostname', 'hostname = ""', 0, true) }}
