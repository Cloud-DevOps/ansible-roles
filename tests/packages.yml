---

- hosts: localhost

  pre_tasks:
    - apt:
        package: "{{ item }}"
      with_items:
        - openssl
        - ca-certificates
        - apt-transport-https
    - apt_key:
        url: https://deb.nodesource.com/gpgkey/nodesource.gpg.key
        id:  68576280
    - apt_repository:
        repo: deb https://deb.nodesource.com/node_6.x {{ ansible_distribution_release }} main
    - apt:
        package: nodejs

  vars:

    manala_npm_packages:
      - is-positive
      - user-home
      - package: negative-zero
        state: absent
      - package: negative-zero
        state: present

  roles:
    - manala.npm

  post_tasks:

    # Asserts
    - assert:
        that:
          - "{{
            ((__manala_npm_packages_results.results|last).ansible_facts.__item.values() if (__manala_npm_packages_results.results|length) else [])|sort == [
              {
                'package': 'is-positive'
              },
              {
                'package': 'user-home'
              },
              {
                'package': 'negative-zero',
                'state': 'present'
              }
            ]
          }}"

    # Goss
    - name: Goss
      raw: "{{ 'echo \"' ~ item|to_yaml ~ '\"|goss validate' }}"
      with_items:
        - file:
            /usr/lib/node_modules/is-positive:
              exists:   true
              filetype: directory
            /usr/lib/node_modules/user-home:
              exists:   true
              filetype: directory
            /usr/lib/node_modules/negative-zero:
              exists:   true
              filetype: directory
