---

- hosts: localhost

  vars:

    manala_environment_variables:
      - FOO: bar
      - BAR: foo
      - BAR: baz

  pre_tasks:
    - copy:
        dest: /etc/environment
        content: |
          BAZ=baz
          FOO=foo

  roles:
    - manala.environment

  post_tasks:

    # Asserts
    - assert:
        that:
          - "{{
            ((__manala_environment_variables_results.results|last).ansible_facts.__item.values() if (__manala_environment_variables_results.results|length) else []) == [
              {
                'name':  'FOO',
                'value': 'bar'
              },
              {
                'name':  'BAR',
                'value': 'baz'
              }
            ]
          }}"

    # Goss
    - name: Goss
      raw: "{{ 'echo \"' ~ item|to_yaml ~ '\"|goss validate' }}"
      with_items:
        - file:
            /etc/environment:
              exists:  true
              filetype: file
              contains:
                - BAZ=baz
                - FOO=bar
                - BAR=baz
