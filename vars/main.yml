---

# Skeletons
manala_skeletons:
  manala_app:
    dev:
      options:
        # Motd
        motd: true
      patterns:
        # Motd
        motd_template: template/manala.j2
        motd:          App - Dev

###########
# Pattern #
###########

___manala_app_pattern:

  ########
  # Motd #
  ########

  motd_template: template/manala.j2
  motd:          App - Php

  ############
  # Timezone #
  ############

  timezone: Etc/UTC

  ###########
  # Locales #
  ###########

  locales: []

  locales_default: C.UTF-8

  #######
  # Env #
  #######

  env: []

  #######
  # Apt #
  #######

  apt_update: true

  apt_components: ['main']

  apt_sources_list_template: sources_list/debian_security_updates.list.j2

  apt_repositories_exclusive: true
  apt_repositories:
    - manala

  apt_preferences: "{{
    [
      '~@dotdeb:100',
      'php@dotdeb' ~ {'5.4': '', '5.5': '_php55', '5.6': '_php56', '7.0': ''}[manala_app_profile_php_version|string],
      'nginx@nginx',
      'nodejs@nodesource_' ~ {'0.10': '0_10', '0.12': '0_12', '4': '4', '5': '5'}[manala_app_profile_nodejs_version|string]
    ]
    + (manala_app_profile_mysql)|ternary(['mysql@mysql' ~ {'5.6': '_5_6', '5.7': '_5_7'}[manala_app_profile_mysql_version|string]],[])
    + (manala_app_profile_phpmyadmin)|ternary(['phpmyadmin@manala'],[])
    + (manala_app_profile_postgresql)|ternary(['postgresql@postgresql'],[])
    + (manala_app_profile_phppgadmin)|ternary(['phppgadmin@manala'],[])
    + (manala_app_profile_redis)|ternary(['redis@dotdeb'],[])
    + (manala_app_profile_mongodb)|ternary(['mongodb@mongodb' ~ {'3.0': '_3_0', '3.1': '_3_1', '3.2': '_3_2'}[manala_app_profile_mongodb_version|string]],[])
    + (manala_app_profile_elasticsearch)|ternary(['elasticsearch@elasticsearch' ~ {'1.5': '_1_5', '1.6': '_1_6', '1.7': '_1_7', '2': '_2'}[manala_app_profile_elasticsearch_version|string]],[])
  }}"

  apt_packages: []

  #######
  # Ssh #
  #######

  ssh_config_sshd_template: config/sshd/manala_{{ manala_app_env }}.j2

  ssh_config_template: config/manala_{{ manala_app_env }}.j2

  #######
  # Git #
  #######

  git_config_template: config/manala_{{ manala_app_env }}.j2

  #############
  # Oh my zsh #
  #############

  ohmyzsh_users:
    - user:     "{{ manala_app_user }}"
      group:    "{{ manala_app_group }}"
      template: users/manala_{{ manala_app_env }}_php.j2
      config:
        - cd {{ manala_app_dir }}

  #######
  # Vim #
  #######

  vim_config_template: "config/manala_{{ manala_app_env }}.j2"

  ################
  # Alternatives #
  ################

  alternatives:
    - name: editor
      path: "{{ manala_vim_bin }}"

  ###########
  # MailHog #
  ###########

  mailhog_config_template: config/manala_{{ manala_app_env }}.j2

  #########
  # Files #
  #########

  files_user:  "{{ manala_app_user }}"
  files_group: "{{ manala_app_group }}"

  files:
    - path:  "{{ manala_app_log_dir }}"
      state: directory
    - path:  "{{ manala_app_cache_dir }}"
      state: directory
    - path:  "{{ manala_app_sessions_dir }}"
      state: directory
    # Manala
    - path:  /usr/share/manala/html
      state: directory
    - path: /usr/share/manala/html/404.html
      content: |
        <!DOCTYPE html>
        <html>
          <head>
            <title>Manala - Error 404</title>
            <style>
              body {
                width: 35em;
                margin: 0 auto;
                font-family: Tahoma, Verdana, Arial, sans-serif;
              }
            </style>
          </head>
          <body>
            <h1>Manala - Error 404</h1>
            <p>Not found</p>
          </body>
        </html>

  #######
  # Npm #
  #######

  npm_packages: []

  #######
  # Php #
  #######

  php_version: "{{ ({'5.4': '5', '5.5': '5', '5.6': '5', '7.0': '7.0'})[manala_app_profile_php_version|string] }}"

  php_sapis: ['cli', 'fpm']

  php_fpm_pools_exclusive: true
  php_fpm_pools:
    - file:     manala.conf
      template: fpm_pools/manala_{{ app_env }}.conf.j2
      config:
        - manala:
          - listen: /var/run/php5-fpm.manala.sock
          - php_admin_value[display_errors]: off

  php_extensions_exclusive: true
  php_extensions: "{{
    ['xdebug']
    + (manala_app_profile_mysql)|ternary(['mysql'],[])
    + (manala_app_profile_postgresql)|ternary(['pgsql'],[])
  }}"

  php_configs_exclusive: true
  php_configs_global: "{{ manala_app_profile_php_version == 5.4 }}"
  php_configs:
    - file: 50-manala-xdebug.ini
      template: configs/manala_xdebug_{{ manala_app_env }}.ini.j2

  php_applications:
    - php-cs-fixer
    - phpcs

  #########
  # Nginx #
  #########

  nginx_config_template: config/manala_http_{{ manala_app_env }}.conf.j2

  nginx_configs_exclusive: true
  nginx_configs:  "{{
    [{
      'file':     'manala.default.conf',
      'template': 'configs/manala_server_' ~ manala_app_env ~ '.conf.j2',
      'config':   [
        {'listen':     '* default_server'},
        {'error_page': '404 /404.html'},
        {'location /404.html': [
          {'root': '/usr/share/manala/html'},
          'internal;'
        ]}
      ]
    }]
    + (manala_app_profile_opcache_dashboard)|ternary([{
      'file':     'manala.opcache_dashboard.conf',
      'template': 'configs/manala_server_' ~ manala_app_env ~ '.conf.j2',
      'config':   [
        {'listen': 2013},
        {'root':   manala_opcache_dashboard_dir},
        {'location /': [
          {'try_files': '$uri /opcache.php$is_args$args'}
        ]},
        {'location ~ ^/.+\\.php(/|$)': [
          {'fastcgi_pass':            'unix:/var/run/php5-fpm.manala.sock'},
          {'fastcgi_split_path_info': '^(.+\\.php)(/.*)$'},
          {'fastcgi_read_timeout':    '60s'},
          {'include':                 'fastcgi_params'},
          {'fastcgi_param':           'SCRIPT_FILENAME $document_root$fastcgi_script_name'},
          {'fastcgi_param':           'HTTPS off'}
        ]}
      ]
    }],[])
    + (manala_app_profile_phpmyadmin)|ternary([{
      'file':     'manala.phpmyadmin.conf',
      'template': 'configs/manala_server_' ~ manala_app_env ~ '.conf.j2',
      'config':   [
        {'listen': 1979},
        {'root':   manala_phpmyadmin_dir},
        {'client_max_body_size': '16M'},
        {'location /': [
          {'try_files': '$uri /index.php$is_args$args'}
        ]},
        {'location ~ ^/.+\\.php(/|$)': [
          {'fastcgi_pass':            'unix:/var/run/php5-fpm.manala.sock'},
          {'fastcgi_split_path_info': '^(.+\\.php)(/.*)$'},
          {'fastcgi_read_timeout':    '60s'},
          {'include':                 'fastcgi_params'},
          {'fastcgi_param':           'SCRIPT_FILENAME $document_root$fastcgi_script_name'},
          {'fastcgi_param':           'HTTPS off'}
        ]}
      ]
    }],[])
    + (manala_app_profile_phppgadmin)|ternary([{
      'file':     'manala.phppgadmin.conf',
      'template': 'configs/manala_server_' ~ manala_app_env ~ '.conf.j2',
      'config':   [
        {'listen': 1980},
        {'root':   manala_phppgadmin_dir},
        {'client_max_body_size': '16M'},
        {'location /': [
          {'try_files': '$uri /index.php$is_args$args'}
        ]},
        {'location ~ ^/.+\\.php(/|$)': [
          {'fastcgi_pass':            'unix:/var/run/php5-fpm.manala.sock'},
          {'fastcgi_split_path_info': '^(.+\\.php)(/.*)$'},
          {'fastcgi_read_timeout':    '60s'},
          {'include':                 'fastcgi_params'},
          {'fastcgi_param':           'SCRIPT_FILENAME $document_root$fastcgi_script_name'},
          {'fastcgi_param':           'HTTPS off'}
        ]}
      ]
    }],[])
    + (manala_app_profile_phpredisadmin)|ternary([{
      'file':     'manala.phpredisadmin.conf',
      'template': 'configs/manala_server_' ~ manala_app_env ~ '.conf.j2',
      'config':   [
        {'listen': 1981},
        {'root':   manala_phpredisadmin_dir},
        {'client_max_body_size': '16M'},
        {'location /': [
          {'try_files': '$uri /index.php$is_args$args'}
        ]},
        {'location ~ ^/.+\\.php(/|$)': [
          {'fastcgi_pass':            'unix:/var/run/php5-fpm.manala.sock'},
          {'fastcgi_split_path_info': '^(.+\\.php)(/.*)$'},
          {'fastcgi_read_timeout':    '60s'},
          {'include':                 'fastcgi_params'},
          {'fastcgi_param':           'SCRIPT_FILENAME $document_root$fastcgi_script_name'},
          {'fastcgi_param':           'HTTPS off'}
        ]}
      ]
    }],[])
  }}"

  ##############
  # Supervisor #
  ##############

  supervisor_config_template: config/manala_{{ manala_app_env }}.conf.j2

  supervisor_configs_exclusive: true
  supervisor_configs:
    - file:     inet-http-server.conf
      template: configs/manala_inet_http_server_{{ manala_app_env }}.conf.j2

  #############
  # PhantomJS #
  #############

  phantomjs_config_template: config/manala_{{ manala_app_env }}.j2

  ########
  # Heka #
  ########

  heka_config_template: config/manala_{{ manala_app_env }}.j2

  heka_configs:
    - file:     input_app.toml
      template: configs/manala_input_app.toml.j2
    - file:     output_app_rtail.toml
      template: configs/manala_output_app_rtail.toml.j2

  #########
  # RTail #
  #########

  rtail_config_template: config/manala_{{ manala_app_env }}.j2

  #########
  # Ngrok #
  #########

  ngrok_configs_exclusive: true
  ngrok_configs:
    - file:     config.yml
      template: configs/manala_{{ manala_app_env }}.yml.j2

  ###########
  # Dnsmasq #
  ###########

  dnsmasq_configs:
    - file: config.conf
      template: configs/manala_{{ manala_app_env }}.conf.j2

  #########
  # MySql #
  #########

  mysql_configs_exclusive: true
  mysql_configs:
    - file: my.cnf
      template: configs/manala_{{ manala_app_env }}.cnf.j2

  mysql_users:
    - name:     "{{ manala_app_user }}"
      password: ~
      host:     "%"
      priv:     "*.*:ALL,GRANT"

  ##############
  # PhpMyAdmin #
  ##############

  #manala_phpmyadmin_version: <4.5 # Php 5.4

  phpmyadmin_configs_exclusive: true
  phpmyadmin_configs:
    - file:     manala.inc.php
      template: configs/manala_{{ manala_app_env }}.inc.php.j2
      servers:
        - id: 1
          config:
            - user: "{{ manala_app_user }}"

  ##############
  # PostgreSQL #
  ##############

  postgresql_version: "{{ manala_app_profile_postgresql_version }}"

  postgresql_config_template: config/manala_{{ manala_app_env }}.conf.j2

  postgresql_config_hba_template: config/hba/manala_{{ manala_app_env }}.conf.j2

  # -> Users

  ##############
  # PhpPgAdmin #
  ##############

  phppgadmin_configs_exclusive: true
  phppgadmin_configs:
    - file:     manala.inc.php
      template: configs/manala_{{ manala_app_env }}.inc.php.j2

  postgresql_users:
    - name:            "{{ manala_app_user }}"
      password:        ~
      role_attr_flags: SUPERUSER

  #########
  # Redis #
  #########

  redis_config_template: config/manala_{{ manala_app_env }}.conf.j2

  #################
  # PhpRedisAdmin #
  #################

  phpredisadmin_configs_exclusive: true
  phpredisadmin_configs:
    - file:     manala.inc.php
      template: configs/manala_{{ manala_app_env }}.inc.php.j2

  ###########
  # MongoDB #
  ###########

  mongodb_config_template: config/manala_{{ manala_app_env }}.conf.j2

  #################
  # Elasticsearch #
  #################

  elasticsearch_plugins:
    - mobz/elasticsearch-head
